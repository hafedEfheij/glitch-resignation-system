<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ´Ø®ÙŠØµ Ø¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .test-result { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .pass { background: #d4edda; }
        .fail { background: #f8d7da; }
    </style>
</head>
<body>
    <h1>ğŸ” ØªØ´Ø®ÙŠØµ Ø¹Ø±Ø¶ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</h1>
    
    <div class="debug-section">
        <h3>1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† API</h3>
        <button onclick="testRawData()">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù…</button>
        <div id="raw-data-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>2. Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚</h3>
        <button onclick="testValidationFunction()">Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚</button>
        <div id="validation-result" class="result"></div>
    </div>
    
    <div class="debug-section">
        <h3>3. Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h3>
        <button onclick="simulateReportDisplay()">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        <div id="report-result" class="result"></div>
    </div>

    <script>
        // Ù†Ø³Ø®Ø© Ù…Ù† Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
        function hasValidReceiptNumber(receiptNumber) {
            console.log('ğŸ” Testing receipt:', receiptNumber, 'Type:', typeof receiptNumber);
            
            if (!receiptNumber || 
                receiptNumber === null || 
                receiptNumber === undefined || 
                receiptNumber === 'null' || 
                receiptNumber === '' ||
                (typeof receiptNumber === 'string' && receiptNumber.trim() === '')) {
                console.log('âŒ Invalid receipt');
                return false;
            }
            
            console.log('âœ… Valid receipt');
            return true;
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        function improvedValidation(receiptNumber) {
            console.log('ğŸ” Improved validation for:', receiptNumber, 'Type:', typeof receiptNumber);
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ string Ø£ÙˆÙ„Ø§Ù‹
            const receiptStr = String(receiptNumber);
            console.log('ğŸ“ Converted to string:', receiptStr);
            
            // ÙØ­Øµ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
            if (!receiptNumber || 
                receiptNumber === null || 
                receiptNumber === undefined || 
                receiptStr === 'null' || 
                receiptStr === 'undefined' ||
                receiptStr.trim() === '') {
                console.log('âŒ Invalid after conversion');
                return false;
            }
            
            console.log('âœ… Valid after conversion');
            return true;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù…
        async function testRawData() {
            const resultDiv = document.getElementById('raw-data-result');
            
            try {
                console.log('ğŸ” Fetching raw data...');
                const response = await fetch('/api/admin/students-enrollments');
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    
                    let html = `<h4>âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† API</h4>`;
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… Ø¥ÙŠØµØ§Ù„Ø§Øª
                    const studentsWithReceipts = data.students.filter(s => 
                        s.enrollments && s.enrollments.some(e => e.receipt_number)
                    );
                    
                    html += `<h5>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø£Ø±Ù‚Ø§Ù… Ø¥ÙŠØµØ§Ù„Ø§Øª: ${studentsWithReceipts.length}</h5>`;
                    
                    studentsWithReceipts.forEach(student => {
                        html += `<div style="border: 1px solid #ddd; margin: 10px 0; padding: 10px;">`;
                        html += `<h6><strong>Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}</strong></h6>`;
                        
                        student.enrollments.forEach((enrollment, index) => {
                            if (enrollment.receipt_number) {
                                const receiptNumber = enrollment.receipt_number;
                                
                                html += `<div style="margin: 5px 0; padding: 5px; background: #f8f9fa;">`;
                                html += `<strong>Ø§Ù„Ù…Ø§Ø¯Ø© ${index + 1}: ${enrollment.course_name}</strong><br>`;
                                html += `<strong>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø®Ø§Ù…:</strong> "${receiptNumber}"<br>`;
                                html += `<strong>Ø§Ù„Ù†ÙˆØ¹:</strong> ${typeof receiptNumber}<br>`;
                                html += `<strong>Ø§Ù„Ø·ÙˆÙ„:</strong> ${receiptNumber ? receiptNumber.length : 'N/A'}<br>`;
                                html += `<strong>JSON:</strong> ${JSON.stringify(receiptNumber)}<br>`;
                                
                                // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙˆØ§Ù„
                                const oldValidation = hasValidReceiptNumber(receiptNumber);
                                const newValidation = improvedValidation(receiptNumber);
                                
                                html += `<strong>Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:</strong> ${oldValidation ? 'âœ… ØµØ§Ù„Ø­' : 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­'}<br>`;
                                html += `<strong>Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©:</strong> ${newValidation ? 'âœ… ØµØ§Ù„Ø­' : 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­'}<br>`;
                                
                                // Ù…Ø§ Ø³ÙŠØ¸Ù‡Ø±
                                const oldDisplay = oldValidation ? receiptNumber : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                                const newDisplay = newValidation ? receiptNumber : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                                
                                html += `<strong>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø¯ÙŠÙ…:</strong> "${oldDisplay}"<br>`;
                                html += `<strong>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø³Ù†:</strong> "${newDisplay}"<br>`;
                                html += `</div>`;
                            }
                        });
                        
                        html += `</div>`;
                    });
                    
                    resultDiv.innerHTML = html;
                } else {
                    throw new Error(data.error || 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©');
                }
            } catch (error) {
                console.error('âŒ API Error:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ Ø®Ø·Ø£: ${error.message}`;
            }
        }
        
        // Ø§Ø®ØªØ¨Ø§Ø± Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚
        function testValidationFunction() {
            const resultDiv = document.getElementById('validation-result');
            
            const testCases = [
                { value: "4588", description: "Ø±Ù‚Ù… Ø¹Ø§Ø¯ÙŠ" },
                { value: "45874", description: "Ø±Ù‚Ù… Ø·ÙˆÙŠÙ„" },
                { value: "REC17484802174270", description: "Ø±Ù‚Ù… Ù…Ø¹ Ù†Øµ" },
                { value: "", description: "Ù†Øµ ÙØ§Ø±Øº" },
                { value: null, description: "null" },
                { value: undefined, description: "undefined" },
                { value: "null", description: "Ù†Øµ 'null'" },
                { value: "   ", description: "Ù…Ø³Ø§ÙØ§Øª ÙÙ‚Ø·" },
                { value: "  4588  ", description: "Ø±Ù‚Ù… Ù…Ø¹ Ù…Ø³Ø§ÙØ§Øª" },
                { value: 0, description: "Ø±Ù‚Ù… ØµÙØ±" },
                { value: "0", description: "Ù†Øµ ØµÙØ±" }
            ];
            
            let html = '<h4>ğŸ§ª Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù‚Ù‚:</h4>';
            
            testCases.forEach((testCase, index) => {
                const oldResult = hasValidReceiptNumber(testCase.value);
                const newResult = improvedValidation(testCase.value);
                
                const oldDisplay = oldResult ? testCase.value : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const newDisplay = newResult ? testCase.value : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                
                const match = oldResult === newResult;
                
                html += `
                    <div class="test-result ${match ? 'pass' : 'fail'}">
                        <strong>Ø§Ø®ØªØ¨Ø§Ø± ${index + 1}: ${testCase.description}</strong><br>
                        Ø§Ù„Ù‚ÙŠÙ…Ø©: ${JSON.stringify(testCase.value)}<br>
                        Ø§Ù„Ù†ÙˆØ¹: ${typeof testCase.value}<br>
                        Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©: ${oldResult ? 'âœ… ØµØ§Ù„Ø­' : 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­'} â†’ "${oldDisplay}"<br>
                        Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©: ${newResult ? 'âœ… ØµØ§Ù„Ø­' : 'âŒ ØºÙŠØ± ØµØ§Ù„Ø­'} â†’ "${newDisplay}"<br>
                        Ø§Ù„ØªØ·Ø§Ø¨Ù‚: ${match ? 'âœ…' : 'âŒ'}
                    </div>
                `;
            });
            
            resultDiv.className = 'result success';
            resultDiv.innerHTML = html;
        }
        
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        async function simulateReportDisplay() {
            const resultDiv = document.getElementById('report-result');
            
            try {
                const response = await fetch('/api/admin/students-enrollments');
                const data = await response.json();
                
                if (!response.ok) throw new Error('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                
                let html = '<h4>ğŸ¨ Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</h4>';
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨ Ù„Ø¯ÙŠÙ‡ Ù…ÙˆØ§Ø¯ Ù…Ø¯ÙÙˆØ¹Ø©
                const studentWithPaidCourses = data.students.find(s => 
                    s.enrollments && s.enrollments.some(e => 
                        (e.payment_status === 'Ø®Ø§Ù„Øµ' || e.payment_status === 'paid') && e.receipt_number
                    )
                );
                
                if (studentWithPaidCourses) {
                    html += `<h5>Ø·Ø§Ù„Ø¨ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${studentWithPaidCourses.name}</h5>`;
                    
                    const paidCourses = studentWithPaidCourses.enrollments.filter(e => 
                        e.payment_status === 'Ø®Ø§Ù„Øµ' || e.payment_status === 'paid'
                    );
                    
                    html += `<table border="1" style="width: 100%; border-collapse: collapse;">`;
                    html += `<tr style="background: #f8f9fa;">
                        <th>#</th>
                        <th>Ø±Ù…Ø² Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø±Ù‚Ù… Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
                        <th>Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                    </tr>`;
                    
                    paidCourses.forEach((course, index) => {
                        const receiptNumber = course.receipt_number;
                        
                        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
                        const isValid = improvedValidation(receiptNumber);
                        const displayValue = isValid ? receiptNumber : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                        const badgeClass = isValid ? 'bg-info' : 'bg-secondary';
                        const badgeColor = isValid ? '#0dcaf0' : '#6c757d';
                        
                        html += `<tr>
                            <td>${index + 1}</td>
                            <td>${course.course_code}</td>
                            <td>${course.course_name || course.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                            <td>${JSON.stringify(receiptNumber)} (${typeof receiptNumber})</td>
                            <td>
                                <span style="background: ${badgeColor}; color: white; padding: 2px 8px; border-radius: 3px;">
                                    ${displayValue}
                                </span>
                            </td>
                        </tr>`;
                    });
                    
                    html += `</table>`;
                } else {
                    html += '<p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ù„Ø§Ø¨ Ù„Ø¯ÙŠÙ‡Ù… Ù…ÙˆØ§Ø¯ Ù…Ø¯ÙÙˆØ¹Ø© Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø¥ÙŠØµØ§Ù„Ø§Øª</p>';
                }
                
                resultDiv.className = 'result success';
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ Ø®Ø·Ø£: ${error.message}`;
            }
        }
        
        // ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.onload = function() {
            console.log('ğŸ”§ Starting receipt display diagnosis...');
            testRawData();
        };
    </script>
</body>
</html>
